// sepet.astro iÃ§indeki checkout button event listener'Ä±nÄ± bununla deÄŸiÅŸtirin

document.getElementById('checkout-btn')?.addEventListener('click', async () => {
  if (cart.length === 0) return;

  const emailInput = document.getElementById('buyer-email') as HTMLInputElement;
  const nameInput = document.getElementById('buyer-name') as HTMLInputElement;
  const surnameInput = document.getElementById('buyer-surname') as HTMLInputElement;

  if (!emailInput.value || !nameInput.value || !surnameInput.value) {
    alert('LÃ¼tfen tÃ¼m bilgileri doldurun!');
    return;
  }

  // Email validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(emailInput.value)) {
    alert('LÃ¼tfen geÃ§erli bir e-posta adresi girin!');
    return;
  }

  // âš ï¸ Ã–NEMLÄ°: Email'i localStorage'a kaydet
  localStorage.setItem('lastOrderEmail', emailInput.value);
  localStorage.setItem('lastOrderName', nameInput.value);
  localStorage.setItem('lastOrderSurname', surnameInput.value);

  console.log('ğŸ’¾ Email localStorage\'a kaydedildi:', emailInput.value);

  const checkoutBtn = document.getElementById('checkout-btn') as HTMLButtonElement;
  const btnText = document.getElementById('checkout-btn-text');

  checkoutBtn.disabled = true;
  if (btnText) btnText.textContent = 'â³ Ã–deme hazÄ±rlanÄ±yor...';

  try {
    const subtotal = calculateSubtotal();
    const shipping = subtotal >= 1000 ? 0 : 50;
    const discount = (subtotal * discountPercent) / 100;
    const total = subtotal + shipping - discount;

    // ğŸ”¥ DOGRU FORMAT - Ä°yzico'nun beklediÄŸi format
    const basketItems = cart.map((item, index) => ({
      id: `BI${index + 1}`,
      name: item.name,
      category1: 'Et ÃœrÃ¼nleri',
      itemType: 'PHYSICAL',
      price: (item.price * item.quantity).toFixed(2), // âš ï¸ String olmalÄ±
    }));

    // âš ï¸ GSM numarasÄ± +90 formatÄ±nda olmalÄ±
    const gsmNumber = '+905555555555'; // VarsayÄ±lan numara, isterseniz form'a ekleyin

    const paymentData = {
      items: basketItems, // âš ï¸ "items" olmalÄ±, "basketItems" deÄŸil
      buyer: {
        id: 'BY' + Date.now(),
        name: nameInput.value,
        surname: surnameInput.value,
        email: emailInput.value,
        gsmNumber: gsmNumber, // âš ï¸ Zorunlu alan
        identityNumber: '11111111111', // âš ï¸ Test iÃ§in sabit
        registrationAddress: 'Kayseri, TÃ¼rkiye',
        ip: '85.34.78.112', // âš ï¸ GerÃ§ek IP'yi alabilirsiniz
        city: 'Kayseri',
        country: 'Turkey',
      },
      shippingAddress: {
        contactName: `${nameInput.value} ${surnameInput.value}`,
        city: 'Kayseri',
        country: 'Turkey',
        address: 'Kayseri, TÃ¼rkiye', // âš ï¸ BoÅŸ bÄ±rakÄ±lamaz
      },
      billingAddress: {
        contactName: `${nameInput.value} ${surnameInput.value}`,
        city: 'Kayseri',
        country: 'Turkey',
        address: 'Kayseri, TÃ¼rkiye', // âš ï¸ BoÅŸ bÄ±rakÄ±lamaz
      },
    };

    console.log('ğŸ“¤ Ã–deme verisi gÃ¶nderiliyor:', paymentData);

    const response = await fetch('/api/create-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(paymentData),
    });

    const data = await response.json();
    console.log('ğŸ“¥ Backend yanÄ±tÄ±:', data);

    if (data.success && data.paymentPageUrl) {
      console.log('âœ… Ã–deme sayfasÄ±na yÃ¶nlendiriliyor...');
      window.location.href = data.paymentPageUrl;
    } else {
      console.error('âŒ Ã–deme baÅŸlatÄ±lamadÄ±:', data);
      alert(`Ã–deme baÅŸlatÄ±lamadÄ±: ${data.error || 'Bilinmeyen hata'}`);
      checkoutBtn.disabled = false;
      if (btnText) btnText.textContent = 'ğŸ’³ Ã–demeye GeÃ§';
    }
  } catch (error) {
    console.error('âŒ Ã–deme hatasÄ±:', error);
    alert('Sunucu hatasÄ±. LÃ¼tfen daha sonra tekrar deneyin.');
    checkoutBtn.disabled = false;
    if (btnText) btnText.textContent = 'ğŸ’³ Ã–demeye GeÃ§';
  }
});