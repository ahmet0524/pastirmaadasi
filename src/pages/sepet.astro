---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
---

<BaseLayout title="Sepetim" description="AlÄ±ÅŸveriÅŸ sepetinizi gÃ¶rÃ¼ntÃ¼leyin ve sipariÅŸinizi tamamlayÄ±n.">
  <Header slot="header" />

  <section class="cart-section">
    <div class="cart-container">
      <h1>ğŸ›’ Sepetim</h1>

      <div class="cart-grid">
        <div class="cart-items-area">
          <div id="cart-items"></div>
          <div id="empty-cart" class="empty hidden">
            <img src="/images/empty-cart.svg" alt="BoÅŸ sepet" width="140" />
            <h3>Sepetiniz boÅŸ</h3>
            <p>HenÃ¼z Ã¼rÃ¼n eklemediniz. AlÄ±ÅŸveriÅŸe baÅŸlayÄ±n!</p>
            <a href="/online-alisveris" class="btn-primary">ÃœrÃ¼nlere GÃ¶z At</a>
          </div>
        </div>

        <div class="cart-summary">
          <div class="card">
            <h2>ğŸ“‹ SipariÅŸ Ã–zeti</h2>

            <div class="form-section">
              <h3>ğŸ‘¤ MÃ¼ÅŸteri Bilgileri</h3>
              <form id="checkout-form">
                <div class="form-group">
                  <label for="buyer-email">E-posta *</label>
                  <input
                    type="email"
                    id="buyer-email"
                    placeholder="ornek@mail.com"
                    required
                  />
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="buyer-name">Ad *</label>
                    <input type="text" id="buyer-name" placeholder="AdÄ±nÄ±z" required />
                  </div>
                  <div class="form-group">
                    <label for="buyer-surname">Soyad *</label>
                    <input type="text" id="buyer-surname" placeholder="SoyadÄ±nÄ±z" required />
                  </div>
                </div>
              </form>
            </div>

            <div class="summary-details">
              <div class="summary-row"><span>Ara Toplam</span><span id="subtotal">0â‚º</span></div>
              <div class="summary-row"><span>Kargo</span><span id="shipping">0â‚º</span></div>
              <div class="summary-row total"><strong>Toplam</strong><strong id="total">0â‚º</strong></div>
            </div>

            <button id="checkout-btn" class="btn-primary btn-full">ğŸ’³ Ã–demeye GeÃ§</button>
            <a href="/online-alisveris" class="back-link">â† AlÄ±ÅŸveriÅŸe Devam Et</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <Footer slot="footer" />
</BaseLayout>

<style>
.cart-section { background: #fafafa; padding: 3rem 1rem; }
.cart-container { max-width: 1100px; margin: 0 auto; }
h1 { text-align: center; color: #b91c1c; margin-bottom: 2rem; }
.cart-grid { display: grid; grid-template-columns: 1fr 360px; gap: 2rem; }
.card { background: white; border-radius: 14px; padding: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
.form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
.form-group label { font-weight: 600; margin-bottom: 0.5rem; color: #333; }
.form-group input { padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
.form-row { display: flex; gap: 1rem; }
.btn-primary { background: linear-gradient(135deg, #dc2626, #b91c1c); color: #fff; border: none; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600; width: 100%; cursor: pointer; transition: 0.2s ease; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220,38,38,0.3); }
.back-link { display: block; margin-top: 1rem; text-align: center; color: #6b7280; text-decoration: none; }
.summary-row { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #eee; }
.summary-row.total { font-size: 1.2rem; color: #111; border-top: 2px solid #b91c1c; margin-top: 1rem; padding-top: 1rem; }
.empty { text-align: center; padding: 2rem; }
.hidden { display: none !important; }
.cart-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid #eee; }
.item-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
.item-info { flex: 1; margin-left: 1rem; }
.qty-controls button { border: none; background: #f3f4f6; padding: 0.3rem 0.8rem; border-radius: 6px; cursor: pointer; }
.qty-controls button:hover { background: #e5e7eb; }
@media (max-width: 768px) { .cart-grid { grid-template-columns: 1fr; } }
</style>

<script>
let cart = [];

function loadCart() {
  cart = JSON.parse(localStorage.getItem("cart") || "[]");
  renderCart();
  updateSummary();
}

function renderCart() {
  const cartEl = document.getElementById("cart-items");
  const emptyEl = document.getElementById("empty-cart");
  const btn = document.getElementById("checkout-btn");

  if (!cartEl || !emptyEl) return;

  if (cart.length === 0) {
    cartEl.innerHTML = "";
    emptyEl.classList.remove("hidden");
    btn.disabled = true;
    return;
  }

  emptyEl.classList.add("hidden");
  btn.disabled = false;

  cartEl.innerHTML = cart
    .map(
      (item, i) => `
      <div class="cart-item">
        <img src="${item.image}" alt="${item.name}" class="item-img" />
        <div class="item-info">
          <h4>${item.name}</h4>
          <p>${item.price}â‚º / ${item.unit}</p>
          <div class="qty-controls">
            <button onclick="changeQty(${i}, -1)">âˆ’</button>
            <span>${item.quantity}</span>
            <button onclick="changeQty(${i}, 1)">+</button>
          </div>
        </div>
        <div class="item-total">${(item.price * item.quantity).toFixed(2)}â‚º</div>
      </div>`
    )
    .join("");
}

window.changeQty = function (i, delta) {
  cart[i].quantity = Math.max(1, cart[i].quantity + delta);
  saveCart();
};

function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
  updateSummary();
}

function calculateSubtotal() {
  return cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
}

function updateSummary() {
  const subtotal = calculateSubtotal();
  const shipping = subtotal >= 1000 ? 0 : 50;
  const total = subtotal + shipping;
  document.getElementById("subtotal").textContent = subtotal.toFixed(2) + "â‚º";
  document.getElementById("shipping").textContent = shipping === 0 ? "Ãœcretsiz" : shipping + "â‚º";
  document.getElementById("total").textContent = total.toFixed(2) + "â‚º";
}

// âœ… Ã¶deme tÄ±klama
document.getElementById("checkout-btn")?.addEventListener("click", async () => {
  const email = document.getElementById("buyer-email").value.trim();
  const name = document.getElementById("buyer-name").value.trim();
  const surname = document.getElementById("buyer-surname").value.trim();

  if (!email || !email.includes("@")) {
    alert("LÃ¼tfen geÃ§erli bir e-posta adresi girin.");
    return;
  }

  localStorage.setItem("lastOrderEmail", email);
  localStorage.setItem("lastOrderName", name);
  localStorage.setItem("lastOrderSurname", surname);

  const cartData = JSON.parse(localStorage.getItem("cart") || "[]");
  if (cartData.length === 0) {
    alert("Sepetiniz boÅŸ, Ã¶deme baÅŸlatÄ±lamaz.");
    return;
  }

  const items = cartData.map((x, i) => ({
    id: `BI${i + 1}`,
    name: x.name,
    category1: "Et ÃœrÃ¼nleri",
    itemType: "PHYSICAL",
    price: (x.price * x.quantity).toFixed(2),
  }));

  const payload = {
    items,
    buyer: { name, surname, email },
    shippingAddress: { city: "Kayseri", address: "Kayseri, TÃ¼rkiye" },
    billingAddress: { city: "Kayseri", address: "Kayseri, TÃ¼rkiye" },
  };

  console.log("ğŸ“¦ Backendâ€™e giden payload:", payload);

  try {
    const res = await fetch("/api/create-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await res.json();

    if (res.ok && data.paymentPageUrl) {
      window.location.href = data.paymentPageUrl;
    } else {
      alert("Ã–deme baÅŸlatÄ±lamadÄ±: " + (data.error || "Bilinmeyen hata"));
    }
  } catch (err) {
    console.error("ğŸš¨ Fetch hatasÄ±:", err);
    alert("BaÄŸlantÄ± kurulamadÄ±. LÃ¼tfen tekrar deneyin.");
  }
});

// âœ… sayfa yÃ¼klendiÄŸinde sepeti yÃ¼kle
document.addEventListener("DOMContentLoaded", loadCart);
</script>
