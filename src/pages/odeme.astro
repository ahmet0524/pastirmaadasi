---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
---

<BaseLayout title="Ödeme Sayfası" description="Pastırma Adası ödeme işlemi">
  <Header slot="header" />

  <section class="payment-page">
    <div class="container">
      <h1>Ödeme Bilgileri</h1>
      <p class="lead">Lütfen aşağıdaki bilgileri doldurarak ödemenizi tamamlayın.</p>

      <form id="paymentForm" class="payment-form">
        <div class="form-group">
          <label for="buyerEmail">E-posta Adresi</label>
          <input type="email" id="buyerEmail" name="buyerEmail" placeholder="ornek@mail.com" required />
        </div>

        <div class="form-group">
          <label for="price">Tutar (₺)</label>
          <input type="number" id="price" name="price" step="0.01" min="1" placeholder="100.00" required />
        </div>

        <button type="submit" class="btn btn-primary">Ödemeyi Başlat</button>
      </form>

      <div id="resultMessage" class="result-message hidden"></div>
    </div>
  </section>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .payment-page {
    padding: 3rem 1rem;
    background: #f9fafb;
    min-height: 100vh;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 2rem;
  }

  h1 {
    font-size: 2rem;
    color: #1f2937;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .lead {
    color: #6b7280;
    text-align: center;
    margin-bottom: 2rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
  }

  input:focus {
    border-color: #dc2626;
    outline: none;
    box-shadow: 0 0 0 1px #dc2626;
  }

  .btn {
    background: #dc2626;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    width: 100%;
    transition: background 0.2s;
  }

  .btn:hover {
    background: #b91c1c;
  }

  .result-message {
    margin-top: 1.5rem;
    text-align: center;
    font-weight: 600;
    padding: 1rem;
    border-radius: 8px;
  }

  .result-message.success {
    background: #ecfdf5;
    color: #065f46;
  }

  .result-message.error {
    background: #fef2f2;
    color: #991b1b;
  }

  .hidden {
    display: none;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("paymentForm");
    const resultMessage = document.getElementById("resultMessage");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultMessage.className = "result-message hidden";

      const buyerEmail = document.getElementById("buyerEmail").value;
      const price = document.getElementById("price").value;

      if (!buyerEmail || !price) {
        showMessage("Lütfen tüm alanları doldurun.", "error");
        return;
      }

      const paymentData = {
        price,
        paidPrice: price,
        buyer: {
          id: "BY001",
          name: "Ziyaretçi",
          surname: "Kullanıcı",
          email: buyerEmail,
          identityNumber: "11111111111",
          registrationAddress: "Kayseri, Türkiye",
          ip: "85.34.78.112",
          city: "Kayseri",
          country: "Turkey",
        },
        shippingAddress: {
          contactName: "Ziyaretçi Kullanıcı",
          city: "Kayseri",
          country: "Turkey",
          address: "Kayseri, Türkiye",
        },
        billingAddress: {
          contactName: "Ziyaretçi Kullanıcı",
          city: "Kayseri",
          country: "Turkey",
          address: "Kayseri, Türkiye",
        },
        basketItems: [
          {
            id: "BI101",
            name: "Pastırma",
            category1: "Et Ürünleri",
            itemType: "PHYSICAL",
            price,
          },
        ],
      };

      try {
        const response = await fetch("/api/create-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(paymentData),
        });

        const data = await response.json();

        if (data.status === "success" && data.paymentPageUrl) {
          showMessage("Ödeme sayfasına yönlendiriliyorsunuz...", "success");
          setTimeout(() => {
            window.location.href = data.paymentPageUrl;
          }, 1500);
        } else {
          showMessage(data.errorMessage || "Ödeme başlatılamadı.", "error");
        }
      } catch (error) {
        console.error("Hata:", error);
        showMessage("Sunucu hatası. Lütfen daha sonra tekrar deneyin.", "error");
      }
    });

    function showMessage(message, type) {
      resultMessage.textContent = message;
      resultMessage.className = `result-message ${type}`;
    }
  });
</script>
