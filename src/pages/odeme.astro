interface CartItem {
    id: number;
    name: string;
    price: number;
    image: string;
    unit: string;
    quantity: number;
  }

  let cart: CartItem[] = [];
  let discountPercent = 0;

  function loadCart() {
    const cartData = localStorage.getItem('cart');
    const discountData = localStorage.getItem('discountPercent');

    cart = cartData ? JSON.parse(cartData) : [];
    discountPercent = discountData ? parseFloat(discountData) : 0;

    if (cart.length === 0) {
      window.location.href = '/sepet';
      return;
    }

    renderOrderSummary();
  }

  function renderOrderSummary() {
    const orderItemsContainer = document.getElementById('order-items');
    if (!orderItemsContainer) return;

    orderItemsContainer.innerHTML = cart.map(item => `
      <div class="order-item">
        <div class="order-item-image">
          <img src="${item.image}" alt="${item.name}">
        </div>
        <div class="order-item-details">
          <h4>${item.name}</h4>
          <p>${item.quantity} adet Ã— ${item.price}â‚º</p>
        </div>
        <div class="order-item-price">
          ${(item.price * item.quantity).toFixed(2)}â‚º
        </div>
      </div>
    `).join('');

    updateSummary();
  }

  function calculateSubtotal(): number {
    return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  }

  function updateSummary() {
    const subtotal = calculateSubtotal();
    const shipping = subtotal >= 1000 ? 0 : 50;
    const discount = (subtotal * discountPercent) / 100;
    const total = subtotal + shipping - discount;

    const subtotalEl = document.getElementById('summary-subtotal');
    const shippingEl = document.getElementById('summary-shipping');
    const discountEl = document.getElementById('summary-discount');
    const discountRow = document.getElementById('summary-discount-row');
    const totalEl = document.getElementById('summary-total');

    if (subtotalEl) subtotalEl.textContent = `${subtotal.toFixed(2)}â‚º`;
    if (shippingEl) shippingEl.textContent = shipping === 0 ? 'Ãœcretsiz' : `${shipping}â‚º`;
    if (discountEl) discountEl.textContent = `-${discount.toFixed(2)}â‚º`;
    if (discountRow) discountRow.classList.toggle('hidden', discount === 0);
    if (totalEl) totalEl.textContent = `${total.toFixed(2)}â‚º`;
  }

  function calculateTotal(): number {
    const subtotal = calculateSubtotal();
    const shipping = subtotal >= 1000 ? 0 : 50;
    const discount = (subtotal * discountPercent) / 100;
    return subtotal + shipping - discount;
  }

  // Fatura adresi toggle
  const sameAddressCheckbox = document.getElementById('same-address') as HTMLInputElement;
  const billingAddressSection = document.getElementById('billing-address-section');

  sameAddressCheckbox?.addEventListener('change', () => {
    billingAddressSection?.classList.toggle('hidden', sameAddressCheckbox.checked);

    const billingInputs = billingAddressSection?.querySelectorAll('input, textarea');
    billingInputs?.forEach(input => {
      (input as HTMLInputElement).required = !sameAddressCheckbox.checked;
    });
  });

  // Form gÃ¶nderimi
  const checkoutForm = document.getElementById('checkout-form') as HTMLFormElement;

  checkoutForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById('submit-payment') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ä°ÅŸleniyor...';

    const formData = new FormData(checkoutForm);
    const sameAddress = (document.getElementById('same-address') as HTMLInputElement).checked;

    const name = formData.get('name') as string;
    const surname = formData.get('surname') as string;
    const email = formData.get('email') as string;
    const phone = formData.get('phone') as string;
    const identity = formData.get('identity') as string;

    const shippingCity = formData.get('shippingCity') as string;
    const shippingAddress = formData.get('shippingAddress') as string;

    const billingCity = sameAddress ? shippingCity : formData.get('billingCity') as string;
    const billingAddress = sameAddress ? shippingAddress : formData.get('billingAddress') as string;

    const subtotal = calculateSubtotal();
    const total = calculateTotal();

    console.log('ğŸ“¦ Payment Request Prepared:');
    console.log('ğŸ’° Subtotal:', subtotal);
    console.log('ğŸ’° Total:', total);
    console.log('ğŸ‘¤ Buyer:', name, surname);
    console.log('ğŸ“§ Email:', email);

    // âœ… CRITICAL: SipariÅŸ bilgilerini localStorage'a kaydet
    // Bu bilgiler Ã¶deme sonrasÄ± email gÃ¶ndermek iÃ§in kullanÄ±lacak
    const orderData = {
      customerEmail: email,
      customerName: `${name} ${surname}`,
      customerPhone: phone,
      customerAddress: shippingAddress,
      items: cart.map(item => ({
        name: item.name,
        quantity: item.quantity,
        price: item.price
      }))
    };

    console.log('ğŸ’¾ Saving order data to localStorage:', orderData);
    localStorage.setItem('pendingOrder', JSON.stringify(orderData));
    console.log('âœ… Order data saved successfully');

    const paymentData = {
      price: subtotal.toFixed(2),
      paidPrice: total.toFixed(2),
      basketId: `BASKET-${Date.now()}`,
      buyer: {
        id: identity,
        name: name,
        surname: surname,
        gsmNumber: phone,
        email: email,
        identityNumber: identity,
        registrationAddress: shippingAddress,
        ip: '85.34.78.112',
        city: shippingCity,
        country: 'Turkey'
      },
      shippingAddress: {
        contactName: `${name} ${surname}`,
        city: shippingCity,
        country: 'Turkey',
        address: shippingAddress
      },
      billingAddress: {
        contactName: `${name} ${surname}`,
        city: billingCity,
        country: 'Turkey',
        address: billingAddress
      },
      basketItems: cart.map(item => ({
        id: item.id.toString(),
        name: item.name,
        category1: 'GÄ±da',
        itemType: 'PHYSICAL',
        price: (item.price * item.quantity).toFixed(2)
      }))
    };

    console.log('ğŸ“¤ Sending request to /api/create-payment...');
    console.log('ğŸ“¦ Payload:', JSON.stringify(paymentData, null, 2));

    try {
      const response = await fetch('/api/create-payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(paymentData)
      });

      console.log('ğŸ“¥ Response Status:', response.status);
      console.log('ğŸ“¥ Response OK:', response.ok);

      let data;
      try {
        data = await response.json();
        console.log('ğŸ“¥ Response Data:', data);
      } catch (jsonError) {
        console.error('âŒ JSON Parse Error:', jsonError);
        const text = await response.text();
        console.error('âŒ Response Text:', text);
        throw new Error('Invalid JSON response from server');
      }

      if (response.ok && data.status === 'success') {
        if (data.paymentPageUrl) {
          console.log('âœ… Payment page URL received:', data.paymentPageUrl);
          console.log('âœ… Redirecting in 1 second...');

          setTimeout(() => {
            console.log('ğŸš€ Redirecting now...');
            window.location.href = data.paymentPageUrl;
          }, 1000);
        } else {
          console.error('âŒ No payment page URL in response:', data);
          alert('Ã–deme sayfasÄ± bulunamadÄ±. LÃ¼tfen tekrar deneyin.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Ã–demeye GeÃ§';
        }
      } else {
        console.error('âŒ Payment request failed:', data);
        const errorMsg = data.errorMessage || data.error || 'Bilinmeyen hata';
        console.error('âŒ Error message:', errorMsg);
        alert('Ã–deme baÅŸlatÄ±lamadÄ±: ' + errorMsg);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ã–demeye GeÃ§';
      }
    } catch (error) {
      console.error('âŒ Network/Fetch Error:', error);
      console.error('âŒ Error details:', {
        name: error.name,
        message: error.message,
        stack: error.stack
      });
      alert('Bir hata oluÅŸtu: ' + error.message + '\n\nLÃ¼tfen console loglarÄ±nÄ± kontrol edin (F12)');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Ã–demeye GeÃ§';
    }
  });

  document.addEventListener('DOMContentLoaded', loadCart);