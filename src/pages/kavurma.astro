<script>
  const cartModal = document.getElementById('cart-modal');
  const successModal = document.getElementById('success-modal');

  (window as any).selectedProduct = null;
  (window as any).selectedVariant = null;

  // Success Modal Timeout ID'sini sakla
  let successModalTimeout: number | null = null;

  // âœ… Sepete Ekle ButonlarÄ±na Event Listener
  document.querySelectorAll('.btn-add-cart').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const productData = btn.getAttribute('data-product');
      if (productData) {
        try {
          const product = JSON.parse(productData);
          (window as any).selectedProduct = product;
          console.log('âœ… ÃœrÃ¼n yÃ¼klendi:', product);
          openCartModal(product);
        } catch (error) {
          console.error('âŒ ÃœrÃ¼n parse hatasÄ±:', error);
        }
      }
    });
  });

  // âœ… Modal AÃ§ma Fonksiyonu
  function openCartModal(product: any) {
    cartModal?.classList.add('active');
    document.body.style.overflow = 'hidden';

    const modalImage = document.getElementById('modal-product-image') as HTMLImageElement;
    const modalName = document.getElementById('modal-product-name');
    const variantOptions = document.getElementById('variant-options');

    if (modalImage) modalImage.src = product.image;
    if (modalName) modalName.textContent = product.name;

    // âœ… VaryantlarÄ± Renderla (Hem size hem label destekli)
    if (variantOptions && product.variants && Array.isArray(product.variants)) {
      variantOptions.innerHTML = '';
      console.log('ðŸ“¦ Varyantlar:', product.variants);

      product.variants.forEach((variant: any, index: number) => {
        const btn = document.createElement('button');
        btn.className = `variant-btn ${index === 0 ? 'active' : ''}`;

        // âœ… Hem size hem label destekle
        const variantSize = variant.size || variant.label;
        btn.textContent = `${variantSize} - ${variant.price}â‚º`;

        btn.addEventListener('click', () => {
          document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // âœ… SeÃ§ilen varyantÄ± kaydet (hem size hem label destekle)
          (window as any).selectedVariant = {
            size: variant.size || variant.label,
            price: variant.price,
            stock: variant.stock
          };

          updateTotalPrice();
        });

        variantOptions.appendChild(btn);
      });

      // Ä°lk varyantÄ± varsayÄ±lan olarak seÃ§
      (window as any).selectedVariant = {
        size: product.variants[0].size || product.variants[0].label,
        price: product.variants[0].price,
        stock: product.variants[0].stock
      };

      updateTotalPrice();
    } else {
      console.error('âŒ Varyant bulunamadÄ±!');
    }

    const qtyInput = document.querySelector('.qty-input') as HTMLInputElement;
    if (qtyInput) qtyInput.value = '1';
  }

  // âœ… Toplam Fiyat GÃ¼ncelleme
  function updateTotalPrice() {
    const qtyInput = document.querySelector('.qty-input') as HTMLInputElement;
    const totalPriceEl = document.getElementById('modal-total-price');
    const selectedVariant = (window as any).selectedVariant;

    if (qtyInput && totalPriceEl && selectedVariant) {
      const quantity = parseInt(qtyInput.value) || 1;
      const total = selectedVariant.price * quantity;
      totalPriceEl.textContent = `${total.toFixed(2)}â‚º`;
    }
  }

  // Miktar Azalt
  document.querySelector('.qty-minus')?.addEventListener('click', () => {
    const input = document.querySelector('.qty-input') as HTMLInputElement;
    if (input) {
      const currentValue = parseInt(input.value) || 1;
      if (currentValue > 1) {
        input.value = (currentValue - 1).toString();
        updateTotalPrice();
      }
    }
  });

  // Miktar ArtÄ±r
  document.querySelector('.qty-plus')?.addEventListener('click', () => {
    const input = document.querySelector('.qty-input') as HTMLInputElement;
    if (input) {
      const currentValue = parseInt(input.value) || 1;
      input.value = (currentValue + 1).toString();
      updateTotalPrice();
    }
  });

  document.querySelector('.qty-input')?.addEventListener('input', updateTotalPrice);

  // Modal Kapat
  document.querySelector('.modal-close')?.addEventListener('click', () => {
    cartModal?.classList.remove('active');
    document.body.style.overflow = '';
  });

  cartModal?.addEventListener('click', (e) => {
    if (e.target === cartModal) {
      cartModal.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  // âœ… SEPETE EKLE
  document.getElementById('confirm-add-cart')?.addEventListener('click', () => {
    const qtyInput = document.querySelector('.qty-input') as HTMLInputElement;
    const quantity = parseInt(qtyInput?.value) || 1;
    const selectedProduct = (window as any).selectedProduct;
    const selectedVariant = (window as any).selectedVariant;

    if (!selectedProduct || !selectedVariant) {
      alert('âŒ LÃ¼tfen bir gramaj seÃ§in!');
      return;
    }

    // âœ… sepet.astro ile uyumlu cart item
    const cartItem = {
      id: `${selectedProduct.id}_${selectedVariant.size}`,
      productId: selectedProduct.id,
      name: selectedProduct.name,
      price: selectedVariant.price,
      image: selectedProduct.image,
      unit: selectedVariant.size,
      quantity: quantity,
      availableVariants: selectedProduct.variants || []
    };

    console.log('ðŸ›’ Sepete eklenecek Ã¼rÃ¼n:', cartItem);

    let cart = [];
    try {
      const cartData = localStorage.getItem('cart');
      cart = cartData ? JSON.parse(cartData) : [];
    } catch (e) {
      console.error('Sepet yÃ¼klenemedi:', e);
      cart = [];
    }

    const existingItemIndex = cart.findIndex(
      (item: any) => item.productId === cartItem.productId && item.unit === cartItem.unit
    );

    if (existingItemIndex > -1) {
      cart[existingItemIndex].quantity += quantity;
      cart[existingItemIndex].availableVariants = cartItem.availableVariants;
      console.log('âœ… Miktar artÄ±rÄ±ldÄ±');
    } else {
      cart.push(cartItem);
      console.log('âœ… Yeni Ã¼rÃ¼n eklendi');
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    window.dispatchEvent(new Event('cartUpdated'));

    console.log('âœ… Sepet gÃ¼ncellendi:', cart);

    // Cart modal'Ä± kapat
    cartModal?.classList.remove('active');

    // Success modal'Ä± aÃ§
    successModal?.classList.add('active');

    // Ã–nceki timeout varsa temizle
    if (successModalTimeout) {
      clearTimeout(successModalTimeout);
    }

    // 5 SANÄ°YE SONRA OTOMATÄ°K KAPAT
    successModalTimeout = window.setTimeout(() => {
      if (successModal?.classList.contains('active')) {
        successModal.classList.remove('active');
        document.body.style.overflow = '';
      }
      successModalTimeout = null;
    }, 5000);
  });

  // Sepete Git butonu
  document.getElementById('go-to-cart')?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (successModalTimeout) {
      clearTimeout(successModalTimeout);
      successModalTimeout = null;
    }

    window.location.href = '/sepet';
  });

  // AlÄ±ÅŸveriÅŸe Devam butonu
  document.getElementById('continue-shopping')?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (successModalTimeout) {
      clearTimeout(successModalTimeout);
      successModalTimeout = null;
    }

    successModal?.classList.remove('active');
    document.body.style.overflow = '';
  });

  // SUCCESS MODAL X BUTONU
  document.querySelector('.success-close')?.addEventListener('click', () => {
    if (successModalTimeout) {
      clearTimeout(successModalTimeout);
      successModalTimeout = null;
    }

    successModal?.classList.remove('active');
    document.body.style.overflow = '';
  });

  // SUCCESS MODAL DIÅžINA TIKLANINCA KAPAT
  successModal?.addEventListener('click', (e) => {
    if (e.target === successModal) {
      if (successModalTimeout) {
        clearTimeout(successModalTimeout);
        successModalTimeout = null;
      }

      successModal.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  // ESC TUÅžU Ä°LE KAPAT
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (cartModal?.classList.contains('active')) {
        cartModal.classList.remove('active');
        document.body.style.overflow = '';
      }
      if (successModal?.classList.contains('active')) {
        if (successModalTimeout) {
          clearTimeout(successModalTimeout);
          successModalTimeout = null;
        }

        successModal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }
  });
</script>