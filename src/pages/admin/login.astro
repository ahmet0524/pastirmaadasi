---
// src/pages/admin/login.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getSession } from '../../lib/auth';

// Oturum kontrolü - eğer zaten giriş yapılmışsa dashboard'a yönlendir
const session = await getSession();
if (session) {
  return Astro.redirect('/admin/dashboard');
}
---

<BaseLayout title="Admin Girişi">
  <section class="admin-login">
    <div class="login-container">
      <div class="login-card">
        <h1>Admin Paneli</h1>
        <p class="login-subtitle">Pastırma Adası Yönetim Sistemi</p>

        <form id="login-form" class="login-form">
          <div class="form-group">
            <label for="email">E-posta</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="pastirmaadasi@gmail.com"
              autocomplete="email"
            />
          </div>

          <div class="form-group">
            <label for="password">Şifre</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="••••••••"
              autocomplete="current-password"
            />
          </div>

          <div id="error-message" class="error-message hidden"></div>

          <button type="submit" class="btn btn-primary btn-full btn-large" id="login-btn">
            Giriş Yap
          </button>
        </form>

        <p class="login-footer">
          <a href="/">← Ana Sayfaya Dön</a>
        </p>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .admin-login {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #c41e3a 0%, #d4af37 100%);
    padding: 2rem;
  }

  .login-container {
    width: 100%;
    max-width: 450px;
  }

  .login-card {
    background: white;
    border-radius: 16px;
    padding: 3rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .login-card h1 {
    text-align: center;
    margin-bottom: 0.5rem;
    color: #1f2937;
    font-size: 2rem;
  }

  .login-subtitle {
    text-align: center;
    color: #6b7280;
    margin-bottom: 2rem;
    font-size: 0.95rem;
  }

  .login-form {
    margin-bottom: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #374151;
  }

  .form-group input {
    width: 100%;
    padding: 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .form-group input:focus {
    outline: none;
    border-color: #c41e3a;
    box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
  }

  .error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    border: 1px solid #fecaca;
  }

  .error-message.hidden {
    display: none;
  }

  .btn {
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1rem;
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-primary {
    background: #c41e3a;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #a01729;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(196, 30, 58, 0.3);
  }

  .btn-full {
    width: 100%;
  }

  .btn-large {
    padding: 1rem 1.5rem;
    font-size: 1.05rem;
  }

  .login-footer {
    text-align: center;
    margin-top: 1.5rem;
  }

  .login-footer a {
    color: #c41e3a;
    font-weight: 500;
    text-decoration: none;
    transition: color 0.2s;
  }

  .login-footer a:hover {
    color: #d4af37;
  }

  @media (max-width: 480px) {
    .login-card {
      padding: 2rem;
    }

    .login-card h1 {
      font-size: 1.75rem;
    }
  }
</style>

<script>
  import { supabase } from '../../lib/supabase';

  const form = document.getElementById('login-form') as HTMLFormElement;
  const loginBtn = document.getElementById('login-btn') as HTMLButtonElement;
  const errorDiv = document.getElementById('error-message') as HTMLElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;

    // Hata mesajını gizle
    errorDiv.classList.add('hidden');

    // Butonu devre dışı bırak
    loginBtn.disabled = true;
    loginBtn.textContent = '⏳ Giriş yapılıyor...';

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) throw error;

      if (!data.session) {
        throw new Error('Oturum oluşturulamadı');
      }

      // Başarılı giriş - dashboard'a yönlendir
      window.location.href = '/admin/dashboard';
    } catch (error: any) {
      console.error('Login error:', error);

      // Hata mesajını göster
      let errorMessage = 'Giriş başarısız. Lütfen bilgilerinizi kontrol edin.';

      if (error.message.includes('Invalid login credentials')) {
        errorMessage = 'E-posta veya şifre hatalı!';
      } else if (error.message.includes('Email not confirmed')) {
        errorMessage = 'E-posta adresiniz onaylanmamış!';
      } else if (error.message) {
        errorMessage = error.message;
      }

      errorDiv.textContent = errorMessage;
      errorDiv.classList.remove('hidden');

      // Butonu tekrar aktif et
      loginBtn.disabled = false;
      loginBtn.textContent = 'Giriş Yap';
    }
  });

  // Enter tuşu ile form gönderimi
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !loginBtn.disabled) {
      form?.requestSubmit();
    }
  });
</script>