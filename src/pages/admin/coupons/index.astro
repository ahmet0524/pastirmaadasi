---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getSession } from '../../../lib/auth';
import { getAllCoupons } from '../../../lib/coupons';

const session = await getSession();
if (!session) {
  throw Astro.redirect('/admin/login');
}

const coupons = await getAllCoupons();
---

<BaseLayout title="Kupon Yönetimi">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <!-- Sidebar -->
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <div class="header-content">
          <div>
            <h1>Kuponlar</h1>
            <p>{coupons.length} kupon bulundu</p>
          </div>
          <a href="/admin/coupons/new" class="btn btn-primary">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Yeni Kupon Oluştur
          </a>
        </div>
      </header>

      <div class="coupons-grid">
        {coupons.map((coupon) => {
          const now = new Date();
          const validUntil = coupon.valid_until ? new Date(coupon.valid_until) : null;
          const isExpired = validUntil && now > validUntil;
          const isLimitReached = coupon.usage_limit && coupon.used_count >= coupon.usage_limit;

          return (
            <div class={`coupon-card ${!coupon.is_active || isExpired || isLimitReached ? 'inactive' : ''}`}>
              <div class="coupon-header">
                <div class="coupon-code">{coupon.code}</div>
                <div class="coupon-discount">%{coupon.discount_percent}</div>
              </div>

              <div class="coupon-details">
                <div class="detail-row">
                  <span>Min. Sipariş:</span>
                  <strong>{coupon.min_order_amount || 0}₺</strong>
                </div>
                <div class="detail-row">
                  <span>Max. İndirim:</span>
                  <strong>{coupon.max_discount_amount || '∞'}₺</strong>
                </div>
                <div class="detail-row">
                  <span>Kullanım:</span>
                  <strong>{coupon.used_count} / {coupon.usage_limit || '∞'}</strong>
                </div>
                {validUntil && (
                  <div class="detail-row">
                    <span>Geçerlilik:</span>
                    <strong>{validUntil.toLocaleDateString('tr-TR')}</strong>
                  </div>
                )}
              </div>

              <div class="coupon-status">
                {isExpired && <span class="badge-error">Süresi Doldu</span>}
                {isLimitReached && <span class="badge-error">Limit Doldu</span>}
                {!coupon.is_active && <span class="badge-error">Pasif</span>}
                {coupon.is_active && !isExpired && !isLimitReached && (
                  <span class="badge-success">Aktif</span>
                )}
              </div>

              <div class="coupon-actions">
                <button
                  class="btn-icon toggle-btn"
                  data-id={coupon.id}
                  data-active={coupon.is_active}
                  title={coupon.is_active ? 'Pasif Yap' : 'Aktif Yap'}
                >
                  {coupon.is_active ? (
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
                      />
                    </svg>
                  ) : (
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  )}
                </button>

                <button class="btn-icon delete-btn" data-id={coupon.id} title="Sil">
                  <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    />
                  </svg>
                </button>
              </div>
            </div>
          );
        })}
      </div>
    </main>
  </div>
</BaseLayout>
