---
// src/pages/admin/dashboard.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getSession } from '../../lib/auth';
import { supabaseAdmin } from '../../lib/supabase';

// Auth kontrol√º
const session = await getSession();
if (!session) {
  return Astro.redirect('/admin/login');
}

// ƒ∞statikleri √ßek
const { data: products } = await supabaseAdmin.from('products').select('id, is_active, category');
const { data: orders } = await supabaseAdmin.from('orders').select('total, status, coupon_codes, coupon_details');
const { data: coupons } = await supabaseAdmin.from('coupons').select('*');

// Kategori bazlƒ± √ºr√ºn sayƒ±larƒ±
const categoryStats = {
  pastirma: products?.filter(p => p.category === 'pastirma').length || 0,
  sucuk: products?.filter(p => p.category === 'sucuk').length || 0,
  manti: products?.filter(p => p.category === 'manti').length || 0,
  kavurma: products?.filter(p => p.category === 'kavurma').length || 0,
  sarkuteri: products?.filter(p => p.category === 'sarkuteri').length || 0,
};

// √áoklu kupon kullanƒ±m sayƒ±larƒ±nƒ± hesapla
const couponUsageMap = new Map();
orders?.forEach(order => {
  // Yeni format: coupon_codes array
  if (order.coupon_codes && Array.isArray(order.coupon_codes)) {
    order.coupon_codes.forEach(code => {
      couponUsageMap.set(code, (couponUsageMap.get(code) || 0) + 1);
    });
  }
  // Eski format i√ßin backward compatibility (eski coupon_code string)
  else if (order.coupon_code && typeof order.coupon_code === 'string') {
    couponUsageMap.set(
      order.coupon_code,
      (couponUsageMap.get(order.coupon_code) || 0) + 1
    );
  }
});

// Aktif kupon sayƒ±sƒ± (ge√ßerli ve kullanƒ±labilir)
const now = new Date();
const activeCouponsCount = coupons?.filter(c => {
  const validUntil = c.valid_until ? new Date(c.valid_until) : null;
  const isExpired = validUntil && now > validUntil;
  const isLimitReached = c.usage_limit && c.used_count >= c.usage_limit;
  return c.is_active && !isExpired && !isLimitReached;
}).length || 0;

// Kuponlu sipari≈ü sayƒ±sƒ± (√ßoklu kupon desteƒüi)
const ordersWithCoupon = orders?.filter(o => {
  return (o.coupon_codes && Array.isArray(o.coupon_codes) && o.coupon_codes.length > 0) ||
         (o.coupon_code && typeof o.coupon_code === 'string');
}).length || 0;

const stats = {
  totalProducts: products?.length || 0,
  activeProducts: products?.filter(p => p.is_active).length || 0,
  totalOrders: orders?.length || 0,
  pendingOrders: orders?.filter(o => o.status === 'pending').length || 0,
  totalRevenue: orders?.reduce((sum, o) => sum + parseFloat(o.total), 0) || 0,
  totalCoupons: coupons?.length || 0,
  activeCoupons: activeCouponsCount,
  couponUsage: coupons?.reduce((sum, c) => sum + (c.used_count || 0), 0) || 0,
  ordersWithCoupon: ordersWithCoupon
};
---

<BaseLayout title="Admin Dashboard">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <h2>Pastƒ±rma Adasƒ±</h2>
        <p>Admin Panel</p>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item active">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          Dashboard
        </a>
        <a href="/admin/products" class="nav-item">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
          </svg>
          √úr√ºnler
        </a>
        <a href="/admin/orders" class="nav-item">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          Sipari≈üler
        </a>
        <a href="/admin/coupons" class="nav-item">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          Kuponlar
        </a>
        <a href="/" class="nav-item">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
          Siteyi G√∂r√ºnt√ºle
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logout-btn" class="btn btn-outline btn-full">
          √áƒ±kƒ±≈ü Yap
        </button>
      </div>
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <h1>Dashboard</h1>
        <p>Ho≈ü geldiniz! ƒ∞≈üte g√ºncel istatistikleriniz</p>
      </header>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">Toplam √úr√ºn</p>
            <p class="stat-value">{stats.totalProducts}</p>
            <p class="stat-detail">{stats.activeProducts} aktif</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">Sipari≈üler</p>
            <p class="stat-value">{stats.totalOrders}</p>
            <p class="stat-detail">{stats.pendingOrders} beklemede</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">Toplam Gelir</p>
            <p class="stat-value">{stats.totalRevenue.toFixed(2)}‚Ç∫</p>
            <p class="stat-detail">Bu ay</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">Kuponlar</p>
            <p class="stat-value">{stats.activeCoupons}</p>
            <p class="stat-detail">{stats.totalCoupons} toplam ¬∑ {stats.couponUsage} kullanƒ±m</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(236, 72, 153, 0.1); color: #ec4899;">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
            </svg>
          </div>
          <div class="stat-content">
            <p class="stat-label">Kuponlu Sipari≈üler</p>
            <p class="stat-value">{stats.ordersWithCoupon}</p>
            <p class="stat-detail">%{stats.totalOrders > 0 ? Math.round((stats.ordersWithCoupon / stats.totalOrders) * 100) : 0} oran</p>
          </div>
        </div>
      </div>

      <!-- Kategori ƒ∞statistikleri -->
      <div class="category-stats">
        <h2>Kategorilere G√∂re √úr√ºnler</h2>
        <div class="category-grid">
          <div class="category-card">
            <div class="category-icon" style="background: #FEE2E2; color: #DC2626;">
              ü•©
            </div>
            <div class="category-info">
              <h3>Pastƒ±rma</h3>
              <p class="category-count">{categoryStats.pastirma} √ºr√ºn</p>
            </div>
          </div>

          <div class="category-card">
            <div class="category-icon" style="background: #FECACA; color: #B91C1C;">
              üå≠
            </div>
            <div class="category-info">
              <h3>Sucuk</h3>
              <p class="category-count">{categoryStats.sucuk} √ºr√ºn</p>
            </div>
          </div>

          <div class="category-card">
            <div class="category-icon" style="background: #FED7AA; color: #EA580C;">
              ü•ü
            </div>
            <div class="category-info">
              <h3>Mantƒ±</h3>
              <p class="category-count">{categoryStats.manti} √ºr√ºn</p>
            </div>
          </div>

          <div class="category-card">
            <div class="category-icon" style="background: #FEF3C7; color: #CA8A04;">
              üçñ
            </div>
            <div class="category-info">
              <h3>Kavurma</h3>
              <p class="category-count">{categoryStats.kavurma} √ºr√ºn</p>
            </div>
          </div>

          <div class="category-card">
            <div class="category-icon" style="background: #D1FAE5; color: #059669;">
              üßÄ
            </div>
            <div class="category-info">
              <h3>≈ûark√ºteri</h3>
              <p class="category-count">{categoryStats.sarkuteri} √ºr√ºn</p>
            </div>
          </div>
        </div>
      </div>

      <div class="quick-actions">
        <h2>Hƒ±zlƒ± ƒ∞≈ülemler</h2>
        <div class="actions-grid">
          <a href="/admin/products" class="action-card">
            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <h3>Yeni √úr√ºn Ekle</h3>
            <p>Kataloƒüa yeni √ºr√ºn ekleyin</p>
          </a>

          <a href="/admin/coupons" class="action-card">
            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
            <h3>Yeni Kupon Olu≈ütur</h3>
            <p>ƒ∞ndirim kuponu tanƒ±mlayƒ±n</p>
          </a>

          <a href="/admin/orders" class="action-card">
            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3>Sipari≈üleri G√∂r√ºnt√ºle</h3>
            <p>Bekleyen sipari≈üleri y√∂netin</p>
          </a>
        </div>
      </div>
    </main>
  </div>
</BaseLayout>

<style>
  .admin-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: 100vh;
  }

  .admin-sidebar {
    background: #1a1a1a;
    color: white;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 0;
    height: 100vh;
  }

  .sidebar-header {
    padding: 2rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .sidebar-header h2 {
    color: var(--secondary);
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .sidebar-header p {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
  }

  .sidebar-nav {
    flex: 1;
    padding: 1.5rem 0;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1.5rem;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.2s;
    text-decoration: none;
  }

  .nav-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: white;
  }

  .nav-item.active {
    background: rgba(212, 175, 55, 0.1);
    color: var(--secondary);
    border-left: 3px solid var(--secondary);
  }

  .sidebar-footer {
    padding: 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .admin-main {
    background: var(--bg-gray);
    padding: 2rem;
    overflow-y: auto;
  }

  .admin-header {
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .admin-header p {
    color: var(--text-gray);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    border-radius: var(--radius-md);
    padding: 1.5rem;
    display: flex;
    gap: 1rem;
    box-shadow: 0 2px 10px var(--shadow);
  }

  .stat-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .stat-content {
    flex: 1;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--text-gray);
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
  }

  .stat-detail {
    font-size: 0.875rem;
    color: var(--text-light);
  }

  /* Kategori ƒ∞statistikleri */
  .category-stats {
    background: white;
    border-radius: var(--radius-md);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px var(--shadow);
  }

  .category-stats h2 {
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
  }

  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .category-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #F9FAFB;
    border-radius: 12px;
    transition: all 0.2s;
  }

  .category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .category-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .category-info h3 {
    font-size: 1rem;
    margin-bottom: 0.25rem;
    color: #1F2937;
  }

  .category-count {
    font-size: 0.875rem;
    color: #6B7280;
    margin: 0;
  }

  .quick-actions {
    background: white;
    border-radius: var(--radius-md);
    padding: 2rem;
    box-shadow: 0 2px 10px var(--shadow);
  }

  .quick-actions h2 {
    margin-bottom: 1.5rem;
  }

  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .action-card {
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    text-align: center;
    transition: var(--transition);
    text-decoration: none;
    color: inherit;
  }

  .action-card:hover {
    border-color: var(--secondary);
    transform: translateY(-5px);
    box-shadow: 0 10px 20px var(--shadow);
  }

  .action-card svg {
    color: var(--secondary);
    margin-bottom: 1rem;
  }

  .action-card h3 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
  }

  .action-card p {
    font-size: 0.875rem;
    color: var(--text-gray);
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
  }

  .btn-outline:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .btn-full {
    width: 100%;
  }

  @media (max-width: 1024px) {
    .admin-layout {
      grid-template-columns: 1fr;
    }

    .admin-sidebar {
      position: relative;
      height: auto;
    }
  }
</style>

<script>
  import { supabase } from '../../lib/supabase';

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    document.cookie = 'sb-access-token=; path=/; max-age=0';
    window.location.href = '/admin/login';
  });
</script>