---
// src/components/ProductCard.astro
export interface Props {
  id: string;
  slug: string;
  name: string;
  price: number;
  images: string[] | string | null;
  unit: string;
  description?: string;
  variants?: any[];
  index?: number;
}

const { id, slug, name, price, images, unit, description, variants, index = 0 } = Astro.props;

// Resim URL'sini güvenli şekilde al
function getImageUrl(imgs: any): string {
  const placeholder = '/assets/image/placeholder.jpg';

  if (!imgs) return placeholder;

  if (Array.isArray(imgs)) {
    if (imgs.length === 0) return placeholder;
    let firstImage = imgs[0];
    if (typeof firstImage === 'string') {
      firstImage = firstImage.replace(/^"|"$/g, '').replace(/""/g, '').trim();
    }
    return firstImage || placeholder;
  }

  if (typeof imgs === 'string') {
    if (imgs.startsWith('{') && imgs.endsWith('}')) {
      const paths = imgs
        .slice(1, -1)
        .split(',')
        .map(p => p.trim().replace(/^"|"$/g, ''));
      if (paths.length > 0 && paths[0]) return paths[0];
    }

    if (imgs.startsWith('[')) {
      try {
        let cleaned = imgs.replace(/""/g, '"').replace(/\\"/g, '"');
        const parsed = JSON.parse(cleaned);
        if (Array.isArray(parsed) && parsed.length > 0) {
          const firstImage = String(parsed[0]).replace(/^"|"$/g, '').trim();
          return firstImage || placeholder;
        }
      } catch (e) {
        console.error('Image parse error:', e);
      }
    }

    const cleaned = imgs.replace(/^"|"$/g, '').trim();
    if (cleaned.startsWith('/') || cleaned.startsWith('http')) {
      return cleaned;
    }
  }

  return placeholder;
}

const imageUrl = getImageUrl(images);
const loadingStrategy = index < 4 ? "eager" : "lazy";
const fetchPriority = index < 2 ? "high" : "auto";
---

<div class="product-card">
  <div class="product-image-wrapper">
    <a href={`/urun/${slug}`} class="product-image-link">
      <img
        src={imageUrl}
        alt={name}
        class="product-image"
        loading={loadingStrategy}
        fetchpriority={fetchPriority}
        onerror="this.onerror=null; this.src='/assets/image/placeholder.jpg';"
      />
      <div class="product-overlay">
        <span class="btn-view-product">Ürünü İncele</span>
      </div>
      <h3 class="product-name-overlay">{name}</h3>
    </a>
  </div>
  <div class="product-info">
    <p class="product-price">
      {price}₺
      <span class="price-unit">/{unit}</span>
    </p>
    <button
      class="btn-add-cart"
      data-product={JSON.stringify({
        id,
        name,
        image: imageUrl,
        variants,
        slug
      })}
    >
      Sepete Ekle
    </button>
  </div>
</div>

<style>
  .product-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  .product-image-wrapper {
    position: relative;
    width: 100%;
    height: 280px;
    overflow: hidden;
    background: #f5f5f5;
  }

  .product-image-link {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .product-card:hover .product-image {
    transform: scale(1.1);
  }

  .product-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(8, 145, 178, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .product-card:hover .product-overlay {
    opacity: 1;
    visibility: visible;
  }

  .btn-view-product {
    padding: 0.875rem 2rem;
    background: white;
    color: #0891B2;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .btn-view-product:hover {
    background: #0891B2;
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
  }

  .product-name-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 15px;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
  }

  .product-info {
    padding: 1.5rem;
  }

  /* Fiyatlar - KIRMIZI */
  .product-price {
    font-size: 1.5rem;
    font-weight: 700;
    color: #DC2626;
    margin-bottom: 1rem;
  }

  .price-unit {
    font-size: 1rem;
    color: #666;
    font-weight: 400;
  }

  /* Sepete Ekle Butonu - KIRMIZI */
  .btn-add-cart {
    width: 100%;
    padding: 0.75rem 1.25rem;
    background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
  }

  .btn-add-cart:hover {
    background: linear-gradient(135deg, #B91C1C 0%, #991B1B 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  }

  @media (max-width: 480px) {
    .product-image-wrapper {
      height: 250px;
    }
  }
</style>